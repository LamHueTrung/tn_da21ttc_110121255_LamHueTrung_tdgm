<script>
    // Ki·ªÉm tra xem token c√≥ t·ªìn t·∫°i hay kh√¥ng
    const token = "{{token}}"; // L·∫•y gi√° tr·ªã token t·ª´ server
    if (token) {
        // L∆∞u token v√†o localStorage
        localStorage.setItem('token', token);
        console.log('Token saved to localStorage:', token);
    } else {
        console.log('No token provided');
    }
</script>
<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
</div>

<!-- Content Row -->
<div class="row" id="page-top">

    <!-- Courses Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Thi·∫øt b·ªã</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{dashboardStats.deviceCount}}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fa-regular fa-hard-drive fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Qu√† t·∫∑ng</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{dashboardStats.giftCount}}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fa-solid fa-gift fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Posts Card  -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Ph√≤ng
                        </div>
                        <div class="row no-gutters align-items-center">
                            <div class="col-auto">
                                <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{dashboardStats.roomCount}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fa-solid fa-house fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Card -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            ƒê∆°n m∆∞·ª£n/tr·∫£ - y√™u c·∫ßu</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{sum dashboardStats.giftOrderCount
                            dashboardStats.borrowCount}}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fa-regular fa-face-dizzy fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Row -->

<div class="container-fluid">

  <!-- Nh√≥m: Thi·∫øt b·ªã -->
  <h5 class="text-dark font-weight-bold mt-4 mb-3">üì¶ Th·ªëng k√™ thi·∫øt b·ªã</h5>
  <div class="row">
    <!-- Bi·ªÉu ƒë·ªì m∆∞·ª£n theo th√°ng -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-primary font-weight-bold">L∆∞·ª£t m∆∞·ª£n thi·∫øt b·ªã theo th·ªùi gian</div>
        <div class="card-body"><canvas id="borrowByDateChart"></canvas></div>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì tr·∫°ng th√°i thi·∫øt b·ªã -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-success font-weight-bold">T√¨nh tr·∫°ng thi·∫øt b·ªã</div>
        <div class="card-body"><canvas id="deviceStatusChart"></canvas></div>
      </div>
    </div>

    <!-- Top thi·∫øt b·ªã m∆∞·ª£n nhi·ªÅu -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-secondary font-weight-bold">Top thi·∫øt b·ªã ƒë∆∞·ª£c m∆∞·ª£n nhi·ªÅu</div>
        <div class="card-body">
          <canvas id="topDevicesChart"></canvas>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr><th>T√™n thi·∫øt b·ªã</th><th>Danh m·ª•c</th><th>L∆∞·ª£t m∆∞·ª£n</th></tr>
              </thead>
              <tbody id="topDevicesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Top gi√°o vi√™n -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-warning font-weight-bold">Top gi·∫£ng vi√™n m∆∞·ª£n nhi·ªÅu thi·∫øt b·ªã</div>
        <div class="card-body">
          <canvas id="topTeachersChart"></canvas>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr><th>H·ªç t√™n</th><th>Email</th><th>L∆∞·ª£t m∆∞·ª£n</th></tr>
              </thead>
              <tbody id="topTeachersTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Nh√≥m: Qu√† t·∫∑ng -->
  <h5 class="text-dark font-weight-bold mt-5 mb-3">üéÅ Th·ªëng k√™ qu√† t·∫∑ng</h5>
  <div class="row">
    <!-- Y√™u c·∫ßu qu√† theo th√°ng -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-info font-weight-bold">S·ªë l∆∞·ª£ng y√™u c·∫ßu qu√† theo th√°ng</div>
        <div class="card-body"><canvas id="giftRequestByMonthChart"></canvas></div>
      </div>
    </div>

    <!-- Top qu√† t·∫∑ng -->
    <div class="col-lg-6 mb-4">
      <div class="card shadow">
        <div class="card-header text-danger font-weight-bold">Top qu√† t·∫∑ng ƒë∆∞·ª£c y√™u c·∫ßu nhi·ªÅu</div>
        <div class="card-body">
          <canvas id="topGiftsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async function () {
    //Bi·ªÉu ƒë·ªì l∆∞·ª£t m∆∞·ª£n thi·∫øt b·ªã theo ng√†y/th√°ng
    const borrowRes = await fetch("/api/statistics/borrow-return/by-date");
    const borrowData = await borrowRes.json();

    new Chart(document.getElementById("borrowByDateChart"), {
        type: "line",
        data: {
            labels: borrowData.data.map(d => d._id),
            datasets: [{
                label: "S·ªë l∆∞·ª£t m∆∞·ª£n",
                data: borrowData.data.map(d => d.total),
                borderColor: "#007bff",
                backgroundColor: "rgba(0,123,255,0.1)",
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: "L∆∞·ª£t m∆∞·ª£n thi·∫øt b·ªã theo th·ªùi gian" }
            }
        }
    });

    //Bi·ªÉu ƒë·ªì tr·∫°ng th√°i thi·∫øt b·ªã
    const statusRes = await fetch("/api/statistics/device/status-counts");
    const statusData = await statusRes.json();

    new Chart(document.getElementById("deviceStatusChart"), {
        type: "doughnut",
        data: {
            labels: statusData.data.map(s => s.status),
            datasets: [{
                data: statusData.data.map(s => s.total),
                backgroundColor: ["#28a745", "#ffc107", "#dc3545", "#17a2b8"]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: "T√¨nh tr·∫°ng thi·∫øt b·ªã" },
                legend: { position: "bottom" }
            }
        }
    });

    //Bi·ªÉu ƒë·ªì Top thi·∫øt b·ªã ƒë∆∞·ª£c m∆∞·ª£n nhi·ªÅu nh·∫•t
    const topDeviceRes = await fetch("/api/statistics/borrow-return/by-device");
    const topDeviceData = await topDeviceRes.json();

    new Chart(document.getElementById("topDevicesChart"), {
        type: "bar",
        data: {
            labels: topDeviceData.data.map(d => d.name),
            datasets: [{
                label: "L∆∞·ª£t m∆∞·ª£n",
                data: topDeviceData.data.map(d => d.totalBorrowed),
                backgroundColor: "#6c757d"
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y', // C·ªôt ngang
            plugins: {
                title: { display: true, text: "Top thi·∫øt b·ªã ƒë∆∞·ª£c m∆∞·ª£n nhi·ªÅu" }
            }
        }
    });

    //Bi·ªÉu ƒë·ªì Top gi√°o vi√™n m∆∞·ª£n nhi·ªÅu thi·∫øt b·ªã
    const topTeacherRes = await fetch("/api/statistics/borrow-return/by-teacher");
    const topTeacherData = await topTeacherRes.json();

    new Chart(document.getElementById("topTeachersChart"), {
        type: "bar",
        data: {
            labels: topTeacherData.data.map(t => t.name),
            datasets: [{
                label: "L∆∞·ª£t m∆∞·ª£n",
                data: topTeacherData.data.map(t => t.totalBorrowed),
                backgroundColor: "#fd7e14"
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: "Top gi√°o vi√™n m∆∞·ª£n thi·∫øt b·ªã" }
            }
        }
    });

    //Bi·ªÉu ƒë·ªì s·ªë l∆∞·ª£ng y√™u c·∫ßu qu√† theo th√°ng
    const giftMonthRes = await fetch("/api/statistics/reward/request-by-month");
    const giftMonthData = await giftMonthRes.json();

    new Chart(document.getElementById("giftRequestByMonthChart"), {
        type: "line",
        data: {
            labels: giftMonthData.data.map(g => g._id),
            datasets: [{
                label: "S·ªë l∆∞·ª£ng y√™u c·∫ßu",
                data: giftMonthData.data.map(g => g.total),
                borderColor: "#6610f2",
                backgroundColor: "rgba(102,16,242,0.1)",
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: "S·ªë l∆∞·ª£ng y√™u c·∫ßu qu√† t·∫∑ng theo th√°ng" }
            }
        }
    });

    //Bi·ªÉu ƒë·ªì Top qu√† t·∫∑ng ƒë∆∞·ª£c y√™u c·∫ßu nhi·ªÅu nh·∫•t
    const topGiftRes = await fetch("/api/statistics/reward/top-requested");
    const topGiftData = await topGiftRes.json();

    new Chart(document.getElementById("topGiftsChart"), {
        type: "bar",
        data: {
            labels: topGiftData.data.map(g => g.name),
            datasets: [{
                label: "L∆∞·ª£t y√™u c·∫ßu",
                data: topGiftData.data.map(g => g.totalRequested),
                backgroundColor: "#20c997"
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: {
                title: { display: true, text: "Top qu√† t·∫∑ng ƒë∆∞·ª£c y√™u c·∫ßu nhi·ªÅu" }
            }
        }
    });

});
</script>
