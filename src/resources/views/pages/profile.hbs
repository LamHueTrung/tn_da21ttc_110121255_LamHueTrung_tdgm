<div class="row" id="page-top">
    <div class="col-md-4 text-center">
        <img id="profileAvatar" class="rounded-square img-thumbnail" alt="Admin Profile Picture">
        <p class="text-muted" id="userRole"></p>
    </div>
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Thông tin chi tiết</h4>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Họ tên: </strong><span id="userFullName"></span></li>
                    <li class="list-group-item"><strong>Tài khoản: </strong><span id="userUsername"></span></li>
                    <li class="list-group-item"><strong>Ngày sinh: </strong><span id="userBirthDate"></span></li>
                    <li class="list-group-item"><strong>Số điện thoại: </strong><span id="userPhone"></span></li>
                    <li class="list-group-item"><strong>Địa chỉnh: </strong><span id="userAddress"></span></li>
                    <li class="list-group-item"><strong>Trạng thái tài khoản: </strong><span id="userStatus"></span>
                    </li>
                    <li class="list-group-item"><strong>Thời gian tạo: </strong><span id="userCreatedAt"></span></li>
                    <li class="list-group-item"><strong>Thời gian cập nhật mới nhất: </strong><span
                            id="userUpdatedAt"></span></li>
                </ul>
            </div>
        </div>

        <!-- Form change password -->
        <div class="card mb-4" id="changePasswordCard" style="display: none;">
            <div class="card-header">
                <h4>Thay đổi mật khẩu</h4>
            </div>
            <div class="card-body">
                <form id="changePasswordForm" class="list-group list-group-flush col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Mật khẩu cũ</label>
                        <input type="password" class="form-control" name="passwordOld" id="passwordOld"
                            placeholder="Nhập mật khẩu cũ" required>
                        <div id="passwordOldError" class="text-danger" style="display:none;"></div>
                        <!-- Error message here -->
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mật khẩu mới</label>
                        <input type="password" class="form-control" name="passwordNew" id="passwordNew"
                            placeholder="Nhập mật khẩu mới" required>
                        <div id="passwordNewError" class="text-danger" style="display:none;"></div>
                        <!-- Error message here -->
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary btn-submit">Đổi mật khẩu</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="text-right mt-4">
            <button type="button" onclick="javascript:history.back()" class="btn btn-secondary btn-previou">Quay
                lại</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const userId = window.location.pathname.split('/').pop();  // Lấy user ID từ URL
        if (userId === 'me') {
            // Nếu user ID là 'admin', tức là trang thông tin cá nhân của admin
            // ẩn phần thay đổi mật khẩu
            document.getElementById("changePasswordCard").style.display = "block";
        }
        // Gửi yêu cầu API để lấy thông tin người dùng
        fetch(`/api/user/getById/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user) {
                    // Cập nhật các thông tin người dùng vào trang
                    document.getElementById("profileAvatar").src = data.user.profile.avatar || "/img/default-avatar.jpg";
                    document.getElementById("userUsername").textContent = data.user.username;
                    document.getElementById("userRole").textContent = data.user.role === 'system_admin' ? 'Quản trị viên' : 'Giảng viên trực';
                    document.getElementById("userFullName").textContent = data.user.profile.fullName;
                    document.getElementById("userBirthDate").textContent = new Date(data.user.profile.birthDate).toLocaleDateString();
                    document.getElementById("userPhone").textContent = data.user.profile.phone;
                    document.getElementById("userAddress").textContent = data.user.profile.address;
                    document.getElementById("userStatus").textContent = data.user.isDeleted ? 'Vô hiệu hoá' : 'Đang hoạt động';
                    document.getElementById("userCreatedAt").textContent = new Date(data.user.createdAt).toLocaleString();
                    document.getElementById("userUpdatedAt").textContent = new Date(data.user.updatedAt).toLocaleString();

                } else {
                    Swal.fire('Lỗi', 'Không thể tải thông tin người dùng', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi', 'Có lỗi xảy ra khi tải dữ liệu người dùng', 'error');
            });

        // Lắng nghe sự kiện submit form thay đổi mật khẩu
        document.getElementById("changePasswordForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Ngăn chặn gửi form theo phương thức POST

            // Lấy giá trị từ các trường input
            const passwordOld = document.getElementById("passwordOld").value;
            const passwordNew = document.getElementById("passwordNew").value;

            // Gửi yêu cầu API để thay đổi mật khẩu
            fetch('/api/user/changPassword', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ passwordOld, passwordNew })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hiển thị thông báo thành công
                    Swal.fire({
                        title: 'Thay đổi mật khẩu thành công!',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Sau khi thành công, đăng xuất và chuyển hướng về trang login
                        sessionStorage.removeItem('hasLoggedIn');
                        fetch('/admin/logout', { method: 'POST' })
                            .then(() => {
                                window.location.href = '/admin'; 
                            });
                    });
                } else {
                    // Hiển thị lỗi từ API
                    if (data.errors) {
                        if (data.errors.passwordOld) {
                            document.getElementById("passwordOldError").textContent = data.errors.passwordOld;
                            document.getElementById("passwordOldError").style.display = "block";
                        } else {
                            document.getElementById("passwordOldError").style.display = "none";
                        }

                        if (data.errors.passwordNew) {
                            document.getElementById("passwordNewError").textContent = data.errors.passwordNew;
                            document.getElementById("passwordNewError").style.display = "block";
                        } else {
                            document.getElementById("passwordNewError").style.display = "none";
                        }
                    }
                    Swal.fire('Lỗi', 'Có lỗi xảy ra khi thay đổi mật khẩu', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi', 'Có lỗi xảy ra, vui lòng thử lại', 'error');
            });
        });
    });
</script>