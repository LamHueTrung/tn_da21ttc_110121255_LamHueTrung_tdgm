<div class="row add-user mb-4">
    <h1 class="title-add-user text-center mb-4">Tạo đơn mượn thiết bị</h1>

    <div class="card-body">
       
        <div class="table-responsive">
            <h3 class="mt-4">Danh sách giảng viên</h3>
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th></th>
                        <th>Họ tên</th>
                        <th>Email</th>
                        <th>Số điện thoại</th>
                        <th>Phòng ban</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each teachers}}
                    <tr>
                        <td>
                            <input style="width: 38px;height: 25px;" type="checkbox" class="checkbox" 
                            data-id="{{this._id}}" 
                            data-name="{{ this.name}}"
                            ></td>
                        <td>{{this.name}}</td>
                        <td>{{this.email}}</td>
                        <td>{{this.phone}}</td>
                        <td>{{this.department}}</td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>

        <div class="d-flex mt-2" style="float: right;">
            <button type="button" onclick="javascript:history.back()" class="btn btn-secondary btn-previou">Quay lại</button>
            <button id="createOrderBtn" type="submit" class="btn btn-system btn-submit ml-2">Tiếp tục chọn phòng</button>
        </div>
            <button id="createOrderNotRoomBtn" type="submit" class="btn btn-system btn-submit ml-2">Hoàn tất mượn cá nhân</button>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll(".checkbox");
        const createOrderBtn = document.getElementById("createOrderBtn");
        const createOrderNotRoomBtn = document.getElementById("createOrderNotRoomBtn");

        let datas = JSON.parse(localStorage.getItem("data")) || [];

        checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", function () {
                const id = this.dataset.id;
                const name = this.dataset.name;

                if (this.checked) {
                    if (!datas.some(data => data.teacherId === id)) {
                        datas.push({ teacherId: id, nameTeacher: name });
                    }
                } else {
                    removeTeacher(id);
                }

                console.log(datas);
            });
        });

        function removeTeacher(id) {
            datas = datas.filter(data => data.teacherId !== id);
        }

        createOrderBtn.addEventListener("click", function () {
            if (datas.length === 1) {
                Swal.fire({
                    icon: "warning",
                    title: "Chưa chọn giảng viên",
                    text: "Vui lòng chọn ít nhất một giảng viên trước khi tiếp tục.",
                });
                return;
            }

            localStorage.setItem("data", JSON.stringify(datas));
            window.location.href = "/borrowRepay/addNewChoiceRoom";
        });

        createOrderNotRoomBtn.addEventListener("click", function () {
            // Lưu tạm dữ liệu (nếu chưa lưu trước đó)
            localStorage.setItem("data", JSON.stringify(datas));

            // Lấy lại dữ liệu từ localStorage
            const storedData = JSON.parse(localStorage.getItem("data")) || [];

            // Tìm giáo viên
            const teacher = storedData.find(item => item.teacherId);
            if (!teacher) {
                Swal.fire("Thiếu thông tin!", "Chưa chọn giảng viên.", "warning");
                return;
            }

            // Lấy danh sách thiết bị
            const devices = storedData
                .filter(item => item.deviceId)
                .map(device => ({
                    deviceId: device.deviceId,
                    quantity: device.quantity
                }));

            if (devices.length === 0) {
                Swal.fire("Thiếu thiết bị!", "Vui lòng chọn ít nhất một thiết bị.", "warning");
                return;
            }

            // Tạo dữ liệu đơn mượn
            const borrowOrder = {
                teacherId: teacher.teacherId,
                roomId: null,
                devices: devices
            };

            console.log("Dữ liệu gửi đi:", borrowOrder);

            Swal.fire({
                title: 'Giảng viên mượn cá nhân?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy',
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("/api/borrowReturn/borrow", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        }, 
                        body: JSON.stringify(borrowOrder)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Kết quả trả về:", data);
                        if (data.success) {

                            Swal.fire({
                                icon: "success",
                                title: "Thành công!",
                                text: "Đơn mượn thiết bị đã được tạo.",
                                confirmButtonText: "OK"
                            }).then(() => {
                                localStorage.removeItem("data");
                                window.location.href = "/borrowRepay/home";
                            });
                        } else {
                            Swal.fire("Lỗi!", data.message || "Không thể tạo đơn.", "error");
                        }
                    })
                    .catch(error => {
                        console.error("Lỗi khi gửi yêu cầu:", error);
                        Swal.fire("Lỗi!", "Không thể kết nối đến máy chủ.", "error");
                    });
                }
            });
        });

    });
</script>
