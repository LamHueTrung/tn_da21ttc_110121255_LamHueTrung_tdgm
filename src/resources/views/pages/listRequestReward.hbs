<div class="card shadow mb-4" id="page-top">
    <div class="card-header py-3">
        <!-- Nút thêm đơn yêu cầu -->
        <button class="btn btn-darks" data-bs-toggle="modal" data-bs-target="#addOrderModal">Thêm đơn yêu cầu</button>
        <a class="btn btn-darks" href="https://drive.google.com/uc?export=download&id=1zIAKEqZoSVJFt-WDKAh8P7w2629rgCWk">File mẫu đơn yêu cầu</a>
    </div>
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Danh sách đơn yêu cầu quà tặng</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Người yêu cầu</th>
                        <th>Người tạo đơn</th>
                        <th>Quà tặng</th>
                        <th>Số lượng</th>
                        <th>Ngày yêu cầu</th>
                        <th>Người yêu cầu</th>
                        <th>Người duyệt đơn</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each orders}}
                    <tr>
                        <td>{{increment @index}}</td>
                        <td>{{this.teacher.name}}</td>
                        <td>{{this.Account.profile.fullName}}</td>
                        <td>{{this.gift.name}}</td>
                        <td>{{this.quantity}}</td>
                        <td>{{formatDate this.created_at}}</td>
                        <td>{{#if (eq this.status "Đã duyệt")}} {{formatDate this.updated_at}} {{else}} Đang chờ... {{/if}} </td>
                        <td>{{#if (eq this.status "Đã duyệt")}} {{this.approved_by.profile.fullName}} {{else}} Đang chờ... {{/if}}</td>
                        <td style="color: {{#if (eq this.status "Chưa duyệt")}}red{{else}}green{{/if}};">
                            {{this.status}}
                        </td>
                        <td>
                            <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#viewOrderModal" onclick="viewOrderDetails('{{this._id}}')">Xem</button>
                            {{#if (eq this.status "Chưa duyệt")}}
                            <button class="btn btn-success btn-sm" onclick="approveOrder('{{this._id}}')">Duyệt đơn</button>
                            {{/if}}
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Thêm Đơn Yêu Cầu -->
<div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOrderModalLabel">Thêm đơn yêu cầu quà tặng từ PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addOrderForm" enctype="multipart/form-data">
                    <!-- File PDF -->
                    <div class="mb-3">
                        <label for="pdfFile" class="form-label">Tải file PDF</label>
                        <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept=".pdf" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Tải lên và tạo đơn</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal để hiển thị chi tiết đơn yêu cầu -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOrderModalLabel">Chi tiết đơn yêu cầu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetails">
                    <!-- Thông tin đơn yêu cầu sẽ được hiển thị ở đây -->
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function approveOrder(orderId) {
        Swal.fire({
            title: 'Bạn có chắc muốn duyệt đơn này?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Duyệt',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/reward/order/approve/${orderId}`, {
                    method: 'PUT'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Đã duyệt!', data.message, 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Lỗi!', data.message, 'error');
                    }
                });
            }
        });
    }

    // Chức năng Xem chi tiết đơn yêu cầu
    function viewOrderDetails(orderId) {
        fetch(`/api/reward/order/getById/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cập nhật modal với thông tin chi tiết đơn yêu cầu
                    const order = data.order;
                    const orderDetails = `
                        <h5><strong>Người yêu cầu:</strong> ${order.teacher.name}</h5>
                        <p><strong>Email:</strong> ${order.teacher.email}</p>
                        <h5><strong>Quà tặng:</strong> ${order.gift.name}</h5>
                        <p><strong>Danh mục:</strong> ${order.gift.category}</p>
                        <p><strong>Giá:</strong> ${order.gift.price} VND</p>
                        <p><strong>Số lượng:</strong> ${order.quantity}</p>
                        <p><strong>Trạng thái:</strong> ${order.status}</p>
                    `;
                    document.getElementById("orderDetails").innerHTML = orderDetails;
                } else {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Không tìm thấy đơn yêu cầu!',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Đã có lỗi xảy ra khi tải chi tiết đơn yêu cầu!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
    }

    // Xử lý form tải lên file PDF và tạo đơn yêu cầu
    document.getElementById('addOrderForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(this);

        fetch('/api/reward/order/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Thành công!',
                    text: 'Đơn yêu cầu đã được tạo thành công!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    location.reload(); // Tải lại trang để hiển thị đơn mới
                });
            } else {
                Swal.fire({
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra khi tạo đơn yêu cầu!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Lỗi!',
                text: 'Đã có lỗi xảy ra!',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    });
</script>
