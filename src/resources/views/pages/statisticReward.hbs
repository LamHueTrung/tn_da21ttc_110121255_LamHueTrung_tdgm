<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Thống kê quà tặng</h6>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <!-- Biểu đồ kho quà thưởng -->
            <div class="col-lg-6 mb-4">
                <canvas id="giftStockChart"></canvas>
            </div>

            <!-- Biểu đồ yêu cầu theo tháng -->
            <div class="col-lg-6 mb-4">
                <canvas id="giftTransactionChart"></canvas>
            </div>
        </div>

        <div class="row">
            <!-- Bảng top quà tặng được yêu cầu -->
            <div class="col-lg-6">
                <h6 class="font-weight-bold text-secondary mb-3">Top quà tặng được yêu cầu nhiều nhất</h6>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Tên quà tặng</th>
                            <th>Danh mục</th>
                            <th>Số lượt yêu cầu</th>
                        </tr>
                    </thead>
                    <tbody id="topGiftsTableBody">
                        <!-- Dữ liệu sẽ được thêm bằng JS -->
                    </tbody>
                </table>
            </div>

            <!-- Bảng top giảng viên yêu cầu -->
            <div class="col-lg-6">
                <h6 class="font-weight-bold text-secondary mb-3">Top giảng viên yêu cầu quà</h6>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Họ tên</th>
                            <th>Email</th>
                            <th>Tổng số yêu cầu</th>
                        </tr>
                    </thead>
                    <tbody id="topTeachersTableBody">
                        <!-- Dữ liệu sẽ được thêm bằng JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async function () {
    // Lấy dữ liệu tồn kho quà tặng
    const stockRes = await fetch("/api/statistics/reward/gift-stock");
    const stockData = await stockRes.json();

    const stockLabels = stockData.data.map(g => g.name);
    const stockValues = stockData.data.map(g => g.quantity_in_stock);

    new Chart(document.getElementById("giftStockChart"), {
        type: "bar",
        data: {
            labels: stockLabels,
            datasets: [{
                label: "Tồn kho",
                data: stockValues,
                backgroundColor: "#28a745"
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: "Biểu đồ tồn kho quà tặng"
                }
            }
        }
    });

    // Lấy dữ liệu yêu cầu theo tháng
    const monthRes = await fetch("/api/statistics/reward/request-by-month");
    const monthData = await monthRes.json();

    new Chart(document.getElementById("giftTransactionChart"), {
        type: "line",
        data: {
            labels: monthData.data.map(d => d._id),
            datasets: [{
                label: "Số lượng yêu cầu",
                data: monthData.data.map(d => d.total),
                borderColor: "#007bff",
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: "Biểu đồ số lượng yêu cầu theo tháng"
                }
            }
        }
    });

    // Bảng Top quà tặng
    const topGiftRes = await fetch("/api/statistics/reward/top-requested");
    const topGiftData = await topGiftRes.json();
    const topGiftBody = document.getElementById("topGiftsTableBody");
    topGiftBody.innerHTML = topGiftData.data.map(gift => `
        <tr>
            <td>${gift.name}</td>
            <td>${gift.category}</td>
            <td>${gift.totalRequested}</td>
        </tr>
    `).join("");

    // Bảng Top giảng viên
    const topTeacherRes = await fetch("/api/statistics/reward/top-teachers");
    const topTeacherData = await topTeacherRes.json();
    const topTeacherBody = document.getElementById("topTeachersTableBody");
    topTeacherBody.innerHTML = topTeacherData.data.map(t => `
        <tr>
            <td>${t.name}</td>
            <td>${t.email}</td>
            <td>${t.totalRequested}</td>
        </tr>
    `).join("");
});
</script>
