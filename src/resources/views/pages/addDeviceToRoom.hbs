<div class="card shadow mb-4" id="page-top">
    <div class="card-header py-3">
        <h6 id="roomName" class="m-0 font-weight-bold text-primary"></h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th></th>
                        <th>Số lượng mượn</th>
                        <th>Tên thiết bị</th>
                        <th>Loại thiết bị</th>
                        <th>Số lượng có thể mượn</th>
                        <th>Hình ảnh</th>
                    </tr>
                </thead>
                <tbody id="deviceList">
                    {{#each devices}}
                        <tr>
                            <td>
                                <input style="width: 38px;height: 25px;" type="checkbox" class="device-checkbox" 
                                data-id="{{this._id}}" 
                                data-name="{{ this.name}}"
                                data-quantity=""
                                ></td>
                            <td>
                                <input style="width: 70px;" type="number">
                            </td>
                            <td>{{ this.name}}</td>
                            <td>{{ this.category}}</td>
                            <td>{{ this.available_quantity }}</td>
                            <td> <img style="width: 50px;" src="{{this.images}}" alt=""></td>
                        </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
        <button id="confirmAddDevice" class="btn btn-primary">Thêm thiết bị</button>
        <button type="button" onclick="javascript:history.back()" class="btn btn-secondary">Quay lại</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        window.roomId = window.location.pathname.split('/').pop();
        window.nameRoom = "";

        // Lấy thông tin phòng
        fetch(`/api/room/getbyid/${roomId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.room) {
                    window.nameRoom = data.room.name;
                    document.getElementById("roomName").textContent = `Thêm thiết bị vào phòng: ${data.room.name}`;
                } else {
                    Swal.fire('Lỗi', 'Không thể tải thông tin phòng', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Lỗi', 'Có lỗi xảy ra khi tải dữ liệu phòng', 'error');
            });

        // Cập nhật data-quantity khi nhập số lượng và tự động checked checkbox
        document.querySelectorAll("tbody tr").forEach(row => {
            let quantityInput = row.querySelector("input[type='number']");
            let checkbox = row.querySelector(".device-checkbox");
            let availableQty = parseInt(row.cells[4].innerText);

            if (quantityInput && checkbox) {
                quantityInput.addEventListener("input", function () {
                    let inputVal = parseInt(this.value);
                    checkbox.dataset.quantity = this.value;

                    if (inputVal > 0 && inputVal <= availableQty) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false;
                    }
                });
            }
        });

        // Xử lý sự kiện khi bấm "Thêm thiết bị"
        document.getElementById("confirmAddDevice").addEventListener("click", async function () {
            let selectedDevices = [];
            let hasInvalid = false;

            document.querySelectorAll("tbody tr").forEach((row) => {
                let checkbox = row.querySelector(".device-checkbox");
                if (checkbox && checkbox.checked) {
                    let quantity = parseInt(checkbox.dataset.quantity);
                    let available = parseInt(row.cells[4].innerText);
                    let name = checkbox.dataset.name;

                    if (isNaN(quantity) || quantity <= 0) {
                        hasInvalid = true;
                        Swal.fire("Lỗi", `Số lượng thiết bị "${name}" không hợp lệ!`, "error");
                        return;
                    }

                    if (quantity > available) {
                        hasInvalid = true;
                        Swal.fire("Lỗi", `Số lượng mượn của thiết bị "${name}" vượt quá số lượng có thể mượn (${available})!`, "error");
                        return;
                    }

                    selectedDevices.push({
                        id: checkbox.dataset.id,
                        name: name,
                        quantity: quantity
                    });
                }
            });

            if (hasInvalid) return;

            if (selectedDevices.length === 0) {
                Swal.fire("Lỗi", "Chưa có thiết bị được chọn!", "error");
                return;
            }

            try {
                for (const d of selectedDevices) {
                    const response = await fetch(`/api/room/${roomId}/assign-devices`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            deviceId: d.id,
                            quantity: d.quantity
                        })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        Swal.fire({
                            title: "Lỗi!",
                            text: data.message,
                            icon: "error",
                            confirmButtonText: "OK"
                        });
                        return;
                    }
                }

                Swal.fire({
                    title: "Thành công!",
                    text: `Thiết bị đã được thêm vào phòng ${nameRoom} thành công!`,
                    icon: "success",
                    confirmButtonText: "OK"
                }).then(() => {
                    window.location.href = `/deviceToRoom/viewDevices/${roomId}`;
                });

            } catch (error) {
                console.error("Error:", error);
                Swal.fire('Lỗi', 'Có lỗi xảy ra, vui lòng thử lại', 'error');
            }
        });
    });
</script>

